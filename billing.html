<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Billing System - Narayan Kirana Store (Fixed Print)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{ --brand:#ff6f61;--primary:#007bff;--accent:#17a2b8;--success:#28a745;--warning:#f8b500;--purple:#6f42c1;--danger:#e74c3c;--ink:#333 }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background:linear-gradient(to right,#fceabb,#f8b500)}
    .container{max-width:1100px;margin:20px auto;background:#fff;padding:20px 22px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .header-top{display:flex;justify-content:space-between;gap:10px;font-size:14px;margin-bottom:6px;color:#555;flex-wrap:wrap}
    h1{text-align:center;margin:6px 0;color:var(--brand);font-size:32px;text-shadow:1px 1px 3px rgba(0,0,0,.2)}
    h2{text-align:center;color:var(--primary);margin:10px 0;text-decoration:underline}
    h3{margin:8px 0;color:#555;font-size:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    label{min-width:60px;font-weight:600;color:var(--ink)}
    input,select{padding:8px;border:1px solid #ccc;border-radius:6px}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 5px rgba(0,123,255,.5)}
    table{width:100%;border-collapse:collapse;margin-top:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);font-size:13px}
    table,th,td{border:1px solid #ddd}
    th{background:linear-gradient(to right,#4facfe,#00f2fe);color:#fff;font-size:13px}
    th,td{padding:8px;text-align:center}
    .btn{padding:7px 12px;cursor:pointer;border:none;border-radius:8px;transition:.2s;font-weight:700;font-size:13px}
    .btn:hover{opacity:.9;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .removeBtn{background-color:var(--danger);color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-weight:700;font-size:12px}
    .removeBtn:hover{background-color:#c0392b}
    .actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .pill{background:#f1f8ff;border:1px dashed #b5d9ff;padding:10px;border-radius:10px}
    .totals{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:8px;margin-top:10px}
    .totals .card{border:1px solid #eee;border-radius:10px;padding:10px;background:#fafafa}
    .right{text-align:right}
    .muted{color:#777}
    .caps { text-transform: uppercase; letter-spacing: .5px; }

    /* New CSS for Upload Section */
    .upload-section { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

    @media(max-width:768px){ .row{flex-direction:column;align-items:flex-start} input,select{width:100%} .actions{justify-content:center} }

    /* PRINT LAYOUT */
    @media print{
      body{background:#fff;margin:0}
      /* Ensure no-print elements, especially the upload and actions, are hidden */
      .no-print,.add-item-row,.action-col,.header-top a,.actions,.upload-section{display:none!important}
      .container{width:210mm;min-height:297mm;padding:12mm 14mm;box-shadow:none!important;} /* Added box-shadow:none */
      table{font-size:11px}
      tr{page-break-inside:avoid}
      #invoiceHeader{display:flex;justify-content:space-between;font-size:12px;margin-bottom:8px}
      .totals .card{border:none;background:#fff;padding:0}
    }

    /* Print-only area styles (Simplified Bill) */
    #simplePrint{display:none}
    @media print{
      #simplePrint{display:block}
      #billRoot > *:not(#simplePrint){display:none !important}
      body{background:#fff !important}
      .container{box-shadow:none !important;padding:0;margin:0}

      #simplePrint{font-family:Arial, sans-serif;font-size:11px;padding:6mm 6mm}
      #simplePrint .print-header{ display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap }
      #simplePrint .muted{color:#333}
      #simplePrint table{width:100%;border-collapse:collapse;font-size:10px;margin-top:6mm;table-layout:auto}
      #simplePrint th,#simplePrint td{border:1px solid #000;padding:3px;text-align:center;vertical-align:top}
      #simplePrint th{font-weight:700}
      #simplePrint thead{display:table-header-group;}
      #simplePrint tfoot{display:table-footer-group;}
    }
  </style>
</head>
<body>
  <div class="container" id="billRoot">
    <div id="simplePrint">
      <div class="print-header">
        <div class="left">
          <div><strong>Narayan Kirana Store</strong></div>
          <div>Address: Main Trimuhani, Gyanpur, Bhadohi</div>
          <div>Mobile: 9935113436, 9935113340</div>
          <div>GST No: 09CXYPD4494C1ZZ</div>
        </div>
        <div class="right">
          <div id="pCust" class="muted"></div>
          <div id="pDateInv" class="muted"></div>
        </div>
      </div>
      <div id="pTableWrap"></div>
    </div>

    <div class="header-top">
      <div>GST No: <strong>09CXYPD4494C1ZZ</strong> | Address: Main Trimuhani, Gyanpur, Bhadohi</div>
      <div>Mobile: 9935113436, 9935113340</div>
    </div>
    <h1>Narayan Kirana Store</h1>

    <div class="upload-section no-print">
      <label for="xlsxFile" style="min-width: unset;">Upload Inventory (XLSX):</label>
      <input type="file" id="xlsxFile" accept=".xlsx, .xls" />
      <span style="font-size: 11px; color: #856404;">Columns needed: Item Name, Sale Rate</span>
    </div>

    <div id="invoiceHeader" class="pill">
      <div class="row" style="margin-bottom:0">
        <div style="flex:1;display:flex;gap:8px;align-items:center"><label for="custName">Name:</label><input type="text" id="custName" aria-label="Customer Name" class="caps" /></div>
        <div style="flex:2;display:flex;gap:8px;align-items:center"><label for="custAddress">Address:</label><input type="text" id="custAddress" aria-label="Customer Address" style="flex:1" class="caps" /></div>
        <div style="flex:1;display:flex;gap:8px;align-items:center"><label for="billDate">Date:</label><input type="date" id="billDate" aria-label="Bill Date" /></div>
        <div style="flex:1;display:flex;gap:8px;align-items:center"><label for="invoiceNo">Inv#</label><input type="text" id="invoiceNo" aria-label="Invoice Number" /></div>
      </div>
    </div>

    <h3>Add Item</h3>
    <div class="row add-item-row">
      <label for="itemName">Item:</label>
      <input type="text" id="itemName" aria-label="Item Name" class="caps" list="itemSuggestions" autocomplete="off" />
      <datalist id="itemSuggestions"></datalist>

      <label for="qty">Qty:</label>
      <input type="number" id="qty" min="0" step="any" style="width:90px" aria-label="Quantity" />
      <select id="unit" aria-label="Unit">
        <option value="kg">Kg</option><option value="gm">Gram</option><option value="liter">Liter</option>
        <option value="ml">ML</option><option value="packet">Packet</option><option value="piece">Piece</option>
      </select>
      <label for="rate">Rate:</label>
      <input type="number" id="rate" min="0" step="any" style="width:110px" aria-label="Rate" placeholder="Sale Rate" />
      <label for="gst">GST%:</label>
      <input type="number" id="gst" min="0" value="0" style="width:70px" aria-label="GST percent" />
      <button class="btn" id="addBtn" style="background:var(--primary);color:#fff">Add</button>
    </div>

    <table id="billTable" aria-label="Billing Table">
      <thead>
        <tr>
          <th>Sr No.</th><th>Item Name</th><th>Quantity</th><th>Rate</th><th>GST %</th><th>Tax Amt</th><th>Line Total</th><th class="action-col">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals">
      <div class="card"><div class="muted">Subtotal</div><div class="right" id="subTotal">₹0.00</div></div>
      <div class="card"><div class="muted">Total Tax</div><div class="right" id="taxTotal">₹0.00</div></div>
      <div class="card"><div class="muted">Discount (₹)</div><input type="number" id="discount" value="0" style="width:100%" /></div>
      <div class="card"><div class="muted">Grand Total</div><div class="right" id="grandTotal">₹0.00</div></div>
    </div>

    <div class="actions no-print">
      <button class="btn" id="calcBtn" style="background:var(--success);color:#fff">Calculate</button>
      <button class="btn" id="clearBtn" style="background:#999;color:#fff">Clear All</button>
      <button class="btn" id="csvBtn" style="background:#222;color:#fff">Export CSV</button>
      <button class="btn" id="printBtn" onclick="printBill()" style="background:var(--accent);color:#fff" type="button">Print Bill</button>
      <button class="btn" id="pdfBtn" style="background:var(--purple);color:#fff">Save PDF</button>
    </div>
    <h3 class="right">Payable: <span id="amountPayable">₹0.00</span></h3>
  </div>

  <script>
    const nfINR = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'});

    // Inventory state
    let INVENTORY_MAP = {}; // To store Name -> Sale Rate mapping
    let ITEM_MASTER = []; // To store list of item names for datalist

    function toCaps(v){ return (v||'').toString().toUpperCase(); }

    function refreshSuggestions(){
      const dl = document.getElementById('itemSuggestions');
      dl.innerHTML = ITEM_MASTER.map(x=>`<option value="${x}"></option>`).join('');
    }

    // --- XLSX FILE HANDLING ---
    document.getElementById('xlsxFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

        // Parse rows and update map
        rows.forEach(row => {
          const name = toCaps(row['Item Name'] || row['item name'] || '');
          const rate = parseFloat(row['Sale Rate'] || row['sale rate'] || 0);
          if(name) {
            INVENTORY_MAP[name] = rate;
            if(!ITEM_MASTER.includes(name)) ITEM_MASTER.push(name);
          }
        });

        ITEM_MASTER.sort();
        localStorage.setItem('nks_inventory_map', JSON.stringify(INVENTORY_MAP));
        localStorage.setItem('nks_items', JSON.stringify(ITEM_MASTER));
        refreshSuggestions();
        alert("Inventory updated successfully!");
        document.getElementById('xlsxFile').value = ''; // Clear file input
      };
      reader.readAsArrayBuffer(file);
    });

    // --- AUTO-FILL RATE ON ITEM SELECT ---
    document.getElementById('itemName').addEventListener('input', function() {
      const val = toCaps(this.value);
      if(INVENTORY_MAP[val]) {
        document.getElementById('rate').value = INVENTORY_MAP[val];
      }
    });

    (function init(){
      const d=new Date();
      document.getElementById('billDate').value=d.toISOString().split('T')[0];
      document.getElementById('invoiceNo').value = "INV-" + Date.now().toString().slice(-6);

      // Load saved inventory from storage
      try {
        INVENTORY_MAP = JSON.parse(localStorage.getItem('nks_inventory_map') || '{}');
        ITEM_MASTER = JSON.parse(localStorage.getItem('nks_items') || '[]');
      } catch(e) {}

      refreshSuggestions();
      bindEvents();
    })();

    function bindEvents(){
      document.getElementById('addBtn').addEventListener('click', addItem);
      document.getElementById('calcBtn').addEventListener('click', updateTotals);
      document.getElementById('discount').addEventListener('input', updateTotals);
      document.getElementById('clearBtn').addEventListener('click', () => { if(confirm('Clear all data?')) location.reload(); });

      ['itemName','custName','custAddress'].forEach(id =>{
        const el = document.getElementById(id);
        el.addEventListener('input', ()=>{ el.value = toCaps(el.value); });
      });

      document.getElementById('pdfBtn').addEventListener('click', saveAsPDF);
      document.getElementById('csvBtn').addEventListener('click', exportCSV); // Re-binding CSV
    }

    function addItem(){
      const name=toCaps(document.getElementById('itemName').value.trim());
      const qty=parseFloat(document.getElementById('qty').value);
      const unit=document.getElementById('unit').value;
      const rate=parseFloat(document.getElementById('rate').value);
      const gst=parseFloat(document.getElementById('gst').value||'0');

      if(!name||isNaN(qty)||isNaN(rate)||qty<=0){alert('Invalid data');return;}

      const lineBase = qty*rate;
      const taxAmt = +(lineBase * (gst/100)).toFixed(2);
      const lineTotal = +(lineBase + taxAmt).toFixed(2);

      const tr=document.createElement('tr');
      // Store raw rate/tax values as data attributes for easier printing calculation
      tr.setAttribute('data-qty', qty);
      tr.setAttribute('data-rate', rate);
      tr.setAttribute('data-gst', gst);

      tr.innerHTML = `<td></td><td>${name}</td><td>${qty} ${unit}</td><td>${rate.toFixed(2)}</td>
        <td>${gst}</td><td>${taxAmt.toFixed(2)}</td><td>${lineTotal}</td>
        <td class="action-col"><button class="removeBtn" onclick="removeItem(this)">Remove</button></td>`;
      document.querySelector('#billTable tbody').appendChild(tr);

      updateSerials(); updateTotals();
      document.getElementById('itemName').value=''; document.getElementById('qty').value='';
      document.getElementById('rate').value='';
      document.getElementById('itemName').focus();
    }

    // Helper function for safe removal
    function removeItem(btn){
      btn.closest('tr').remove();
      updateSerials();
      updateTotals();
    }


    function updateSerials(){
      document.querySelectorAll('#billTable tbody tr').forEach((r,i)=>r.children[0].textContent=i+1);
    }

    // Function to calculate all totals
    function getNumbers(){
        let sub=0, tax=0, grand=0;
        document.querySelectorAll('#billTable tbody tr').forEach(r=>{
            // Use cell content for existing rows (safer in this structure)
            const rate=parseFloat(r.children[3].textContent)||0;
            const gst=parseFloat(r.children[4].textContent)||0;
            const qtyUnit=r.children[2].textContent.trim();
            const qty=parseFloat(qtyUnit.split(' ')[0])||0;

            const base=qty*rate;
            const t=base*(gst/100);
            sub+=base; tax+=t; grand+=base+t;
        });
        const discount=parseFloat(document.getElementById('discount').value||'0');
        const net = Math.max(0, grand - discount);
        return {sub: +sub.toFixed(2), tax: +tax.toFixed(2), grand: +grand.toFixed(2), discount: +discount.toFixed(2), net: +net.toFixed(2)};
    }

    function updateTotals(){
      const {sub,tax,grand,discount,net}=getNumbers();
      document.getElementById('subTotal').textContent = nfINR.format(sub);
      document.getElementById('taxTotal').textContent = nfINR.format(tax);
      document.getElementById('grandTotal').textContent = nfINR.format(grand);
      document.getElementById('amountPayable').textContent = nfINR.format(net);
    }

    // --- PRINT SUPPORT FUNCTIONS (FIXED) ---

    function buildSimplePrint(){
      const custName=toCaps((document.getElementById('custName').value||'').trim());
      const custAddr=toCaps((document.getElementById('custAddress').value||'').trim());
      const billDate=document.getElementById('billDate').value||new Date().toISOString().split('T')[0];
      const invoiceNo=(document.getElementById('invoiceNo').value||'').trim();

      document.getElementById('pCust').textContent = `Customer: ${custName || '-'} | Address: ${custAddr || '-'}`;
      document.getElementById('pDateInv').textContent = `Date: ${billDate} | Invoice#: ${invoiceNo || '-'}`;

      const wrap=document.getElementById('pTableWrap');
      wrap.innerHTML='';

      const tbl=document.createElement('table');
      const thead=document.createElement('thead');
      const tbody=document.createElement('tbody');
      const tfoot=document.createElement('tfoot');

      thead.innerHTML = `
        <tr>
          <th>Sr No.</th><th>Item Name</th><th>Quantity</th><th>Rate</th>
          <th>GST %</th><th>Tax Amt</th><th>Line Total</th>
        </tr>`;

      const rows=[...document.querySelectorAll('#billTable tbody tr')];
      rows.forEach((r,i)=>{
        const c = r.children;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td style="text-align:left">${c[1]?.textContent ?? ''}</td>
          <td>${c[2]?.textContent ?? ''}</td>
          <td>${c[3]?.textContent ?? ''}</td>
          <td>${c[4]?.textContent ?? ''}</td>
          <td>${c[5]?.textContent ?? ''}</td>
          <td>${c[6]?.textContent ?? ''}</td>
        `;
        tbody.appendChild(tr);
      });

      const {grand, net, discount} = getNumbers();

      tfoot.innerHTML = `
        <tr>
          <th colspan="6" style="text-align:right">Discount (₹)</th>
          <th>${(discount).toFixed(2)}</th>
        </tr>
        <tr>
          <th colspan="6" style="text-align:right">Grand Total (₹)</th>
          <th>${(grand).toFixed(2)}</th>
        </tr>
        <tr>
          <th colspan="6" style="text-align:right">Amount Payable (₹)</th>
          <th>${(net).toFixed(2)}</th>
        </tr>
      `;

      tbl.appendChild(thead);
      tbl.appendChild(tbody);
      tbl.appendChild(tfoot);
      wrap.appendChild(tbl);
    }

    function prepareForPrint(){
      updateTotals(); // Ensure latest totals are calculated
      buildSimplePrint(); // Build the print-only structure
    }

    function printBill(){
      prepareForPrint();
      window.print();
    }

    // Re-bind to ensure pre-print actions are taken
    window.addEventListener('beforeprint', prepareForPrint);


    // --- CSV & PDF FUNCTIONS ---
    function exportCSV(){
      const rows=[["Sr No.","Item Name","Quantity","Rate","GST %","Tax Amt","Line Total"]];
      document.querySelectorAll('#billTable tbody tr').forEach((r)=>{
        rows.push([
          r.children[0].textContent,r.children[1].textContent,r.children[2].textContent,
          r.children[3].textContent,r.children[4].textContent,r.children[5].textContent,
          r.children[6].textContent
        ]);
      });
      const totals=getNumbers();
      rows.push([]);
      rows.push(["Subtotal","","","","",'', totals.sub.toFixed(2)]);
      rows.push(["Tax Total","","","","",'', totals.tax.toFixed(2)]);
      rows.push(["Discount","","","","",'', totals.discount.toFixed(2)]);
      rows.push(["Grand Total","","","","",'', totals.net.toFixed(2)]);
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const cust=(document.getElementById('custName').value.trim()||'bill').replace(/\s+/g,'_');
      const date=document.getElementById('billDate').value||new Date().toISOString().split('T')[0];
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=`${cust}_${date}.csv`;
      document.body.appendChild(link);link.click();link.remove();
    }

    function saveAsPDF(){
      prepareForPrint(); // Ensure the print area is ready for PDF conversion
      const element=document.querySelector('#simplePrint'); // Target the print area for cleaner PDF
      const custName=(document.getElementById('custName').value.trim()||'bill').replace(/\s+/g,'_');
      const billDate=document.getElementById('billDate').value||new Date().toISOString().split('T')[0];
      const filename=`${custName}_${billDate}.pdf`;

      // Temporarily show the simplePrint div for html2pdf to process it correctly
      const billRoot = document.getElementById('billRoot');
      const simplePrint = document.getElementById('simplePrint');
      const originalDisplay = simplePrint.style.display;
      simplePrint.style.display = 'block';
      billRoot.style.boxShadow = 'none';

      html2pdf().from(element).set({
        margin:10,
        filename,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2, useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).save().then(()=>{
          // Restore original display state after PDF generation is complete
          simplePrint.style.display = originalDisplay;
          billRoot.style.boxShadow = '';
      });
    }

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>
</body>
</html>
